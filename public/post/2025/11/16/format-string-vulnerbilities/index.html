<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A simple, minimal blog for those who love text.">
    <title>Format String Vulnerbilities | AboutMe</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="http://localhost:1313/css/theme-override.css">
    
  </head>

  <body>
    <header>
      <nav>
        <ul>
          
          
          <li class="pull-left ">
            <a href="http://localhost:1313/">~/aboutme</a>
          </li>
          
          
          <li class="pull-left ">
            <a href="/blog/">~/blog</a>
          </li>
          
          
          <li class="pull-left ">
            <a href="/categories/">~/categories</a>
          </li>
          
          
          <li class="pull-left ">
            <a href="/tags/">~/tags</a>
          </li>
          

          

        </ul>
      </nav>
    </header>


<div class="article-meta">
<h1><span class="title">Format String Vulnerbilities</span></h1>
<h2 class="author">clgp</h2>
<h2 class="date">2025/11/16</h2>
<p class="terms">
  
  
  Categories: <a href="/categories/ctf">ctf</a> 
  
  
  
  Tags: <a href="/tags/pwn">pwn</a> 
  
  
</p>
</div>



<div class="content-wrapper">
  <main>
    <h2 id="fmtstr_payload-in-pwntools">fmtstr_payload() in pwntools</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>from pwn import *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fmtstr_payload<span style="color:#f92672">(</span>offset, writes, numbwritten<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;byte&#39;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>+offset is the stack offset of where you want to do the payload</strong></p>
<p><strong>+writes is a pair value { address_to_write_to: value_to_write }</strong></p>
<p><strong>+numbwritten (optional) is the number of byte that have been printed before the
payload is processed</strong></p>
<h2 id="example">Example</h2>
<p>Let&rsquo;s say you are doing a CTF challenge where:</p>
<p>You found a format string vulnerability.</p>
<p>You used a debugger (like GDB) and found that your payload starts at offset 7.</p>
<p>You want to overwrite a variable called <em>is_admin</em> located at address
0x0804a02c with the value 1 to get admin privileges.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The address of the &#39;is_admin&#39; variable</span>
</span></span><span style="display:flex;"><span>admin_variable_address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0804a02c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The value we want to write (1)</span>
</span></span><span style="display:flex;"><span>new_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The stack offset we found</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate the payload</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> fmtstr_payload(offset, {admin_variable_address: new_value})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You would then send this payload to the vulnerable program</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./vulnerable_program&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p.sendline(payload)</span>
</span></span></code></pre></div><p>When the vulnerable program executes printf(payload),
this specially crafted string will cause it to write the value 1 into the address 0x0804a02c.
fmtstr_payload() automatically handles all the %n, %hn, %hhn specifiers and padding (%&hellip;c)
to get the exact value you want written to the exact address.</p>
<h2 id="why-this-function-fmtstr_-actually-help">Why this function <em>fmtstr_payload()</em> actually help</h2>
<p>This function help yout to write payload which control
exactly what value gets written to which address.</p>
<h2 id="why-this-is-a-lifesaver-the-manual-method"> Why This Is a Lifesaver: The Manual Method</h2>
<p><strong>Our Goal:</strong> Write the 4-byte value <strong><code>0xDEADBEEF</code></strong> to the address <strong><code>0x12345678</code></strong>.</p>
<blockquote>
<p><strong>Assumptions:</strong></p>
<ul>
<li>We are on a little-endian system (most x86/ARM CPUs).</li>
<li>This means <code>0xDEADBEEF</code> at <code>0x12345678</code> is stored in memory as:
     <code>0xEF</code> at <code>0x1234567B</code>
     <code>0xBE</code> at <code>0x1234567A</code>
     <code>0xAD</code> at <code>0x12345679</code>
     <code>0xDE</code> at <code>0x12345678</code></li>
<li>We will use <code>%hhn</code> (which writes 1 byte) for our writes.</li>
<li>The <code>printf</code> byte counter (which <code>%hhn</code> uses) starts at <code>0</code>.</li>
</ul>
</blockquote>
<hr>
<h3 id="step-0-the-sort">Step 0: The <em>Sort</em></h3>
<p>The <code>printf</code> counter can only <strong>increase</strong>. We can&rsquo;t write <code>222</code> bytes and then write <code>173</code> bytes, because the counter would already be past <code>173</code>.</p>
<p>Therefore, we <strong>must sort our writes from the lowest byte value to the highest</strong>:</p>
<ol>
<li> Write <code>0xAD</code> (<code>173</code>) -&gt; to address <code>0x12345679</code></li>
<li> Write <code>0xBE</code> (<code>190</code>) -&gt; to address <code>0x1234567A</code></li>
<li> Write <code>0xDE</code> (<code>222</code>) -&gt; to address <code>0x12345678</code></li>
<li> Write <code>0xEF</code> (<code>239</code>) -&gt; to address <code>0x1234567B</code></li>
</ol>
<p>Our payload will perform 4 writes in this specific order.</p>
<hr>
<h3 id="step-1-write-the-value-173-0xad">Step 1: Write the value 173 (0xAD)</h3>
<ul>
<li><strong>Goal:</strong> Write <code>173</code> to <code>0x12345679</code>.</li>
<li><strong>Current Counter:</strong> <code>0</code></li>
<li><strong>Action:</strong> We need the counter to become <code>173</code>. We do this by printing <code>173</code> padding characters.</li>
<li><strong>Payload Part:</strong> <code>%173c...</code> (followed by a <code>%...$hhn</code> specifier pointing to <code>0x12345679</code>)</li>
<li><strong>Result:</strong>
    * <code>printf</code> prints <code>173</code> characters.
    * The counter increases from <code>0</code> to <strong><code>173</code></strong>.
    * The <code>%hhn</code> triggers and writes the value <code>173</code> (which is <code>0xAD</code>) to the address <code>0x12345679</code>.</li>
</ul>
<h3 id="step-2-write-the-value-190-0xbe">Step 2: Write the value 190 (0xBE)</h3>
<ul>
<li><strong>Goal:</strong> Write <code>190</code> to <code>0x1234567A</code>.</li>
<li><strong>Current Counter:</strong> <code>173</code></li>
<li><strong>Action:</strong> We need the counter to become <code>190</code>. It&rsquo;s already at <code>173</code>, so we only need to print an additional <strong><code>190 - 173 = 17</code></strong> characters.</li>
<li><strong>Payload Part:</strong> <code>%17c...</code> (followed by a <code>%...$hhn</code> specifier pointing to <code>0x1234567A</code>)</li>
<li><strong>Result:</strong>
    * <code>printf</code> prints an additional <code>17</code> characters.
    * The counter increases from <code>173</code> to <strong><code>190</code></strong>.
    * The <code>%hhn</code> triggers and writes the value <code>190</code> (which is <code>0xBE</code>) to the address <code>0x1234567A</code>.</li>
</ul>
<h3 id="step-3-write-the-value-222-0xde">Step 3: Write the value 222 (0xDE)</h3>
<ul>
<li><strong>Goal:</strong> Write <code>222</code> to <code>0x12345678</code>.</li>
<li><strong>Current Counter:</strong> <code>190</code></li>
<li><strong>Action:</strong> We need the counter to become <code>222</code>. We need to print an additional <strong><code>222 - 190 = 32</code></strong> characters.</li>
<li><strong>Payload Part:</strong> <code>%32c...</code> (followed by a <code>%...$hhn</code> specifier pointing to <code>0x12345678</code>)</li>
<li><strong>Result:</strong>
    * <code>printf</code> prints an additional <code>32</code> characters.
    * The counter increases from <code>190</code> to <strong><code>222</code></strong>.
    * The <code>%hhn</code> triggers and writes the value <code>222</code> (which is <code>0xDE</code>) to the address <code>0x12345678</code>.</li>
</ul>
<h3 id="step-4-write-the-value-239-0xef">Step 4: Write the value 239 (0xEF)</h3>
<ul>
<li><strong>Goal:</strong> Write <code>239</code> to <code>0x1234567B</code>.</li>
<li><strong>Current Counter:</strong> <code>222</code></li>
<li><strong>Action:</strong> We need the counter to become <code>239</code>. We need to print an additional <strong><code>239 - 222 = 17</code></strong> characters.</li>
<li><strong>Payload Part:</strong> <code>%17c...</code> (followed by a <code>%...$hhn</code> specifier pointing to <code>0x1234567B</code>)</li>
<li><strong>Result:</strong>
    * <code>printf</code> prints an additional <code>17</code> characters.
    * The counter increases from <code>222</code> to <strong><code>239</code></strong>.
    * The <code>%hhn</code> triggers and writes the value <code>239</code> (which is <code>0xEF</code>) to the address <code>0x1D234567B</code>.</li>
</ul>
<hr>
<h3 id="summary">Summary</h3>
<p>After 4 complex, ordered steps, we have performed 4 writes:</p>
<ul>
<li><code>0x12345678</code> now contains <code>0xDE</code></li>
<li><code>0x12345679</code> now contains <code>0xAD</code></li>
<li><code>0x1234567A</code> now contains <code>0xBE</code></li>
<li><code>0x1234567B</code> now contains <code>0xEF</code></li>
</ul>
<p>All 4 of these bytes combine to form the value <strong><code>0xDEADBEEF</code></strong> at the address <code>0x12345678</code>.</p>
<p>This is the extremely complex logic (sorting, calculating differences, handling padding, and managing addresses) that <code>fmtstr_payload()</code> automates for you in a single, clean line of code.</p>

    <a href="/"> >> Home</a>
  </main>
</div>
<footer>
  
  
  <script>
    (function () {
      function center_el(tagName) {
        var tags = document.getElementsByTagName(tagName),
          i,
          tag;
        for (i = 0; i < tags.length; i++) {
          tag = tags[i];
          var parent = tag.parentElement;
          
          if (parent.childNodes.length === 1) {
            
            if (parent.nodeName === "A") {
              parent = parent.parentElement;
              if (parent.childNodes.length != 1) continue;
            }
            if (parent.nodeName === "P") parent.style.textAlign = "center";
          }
        }
      }
      var tagNames = ["img", "embed", "object"];
      for (var i = 0; i < tagNames.length; i++) {
        center_el(tagNames[i]);
      }
    })();
  </script>

  
  <hr />
  Open-Source | <a href="https://github.com/clgp-aint-cool">GitHub</a> 
</footer>

